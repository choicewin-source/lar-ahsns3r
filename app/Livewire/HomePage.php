<?php

namespace App\Livewire;

use App\Models\Product;
use App\Models\Category;
use App\Models\Ad;
use Livewire\Component;
use Livewire\WithPagination;
use Livewire\Attributes\Layout;
use Illuminate\Support\Facades\Cache;

#[Layout('layouts.app')]
class HomePage extends Component
{
    use WithPagination;

    public $search = ''; 
    public $selectedCategory = ''; 
    public $selectedCity = ''; // ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø³Ù…
    public $selectedShop = ''; // Ø¬Ø¯ÙŠØ¯: Ù„ÙÙ„ØªØ±Ø© Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ù„ Ù…Ø¹ÙŠÙ†
    public $sub_category = ''; // Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯
    public $condition = ''; // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬: Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ù…Ø³ØªØ¹Ù…Ù„
    public $tickerText = ''; // Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ­Ø±Ùƒ

    // Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª
    public $categoriesList = [];

    public $cities = ['Ø´Ù…Ø§Ù„ ØºØ²Ø©', 'Ù…Ø¯ÙŠÙ†Ø© ØºØ²Ø©', 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØ³Ø·Ù‰', 'Ø®Ø§Ù†ÙŠÙˆÙ†Ø³', 'Ø±ÙØ­'];
    public $ads = [];

    public function selectCity($city)
    {
        $this->selectedCity = $city === $this->selectedCity ? '' : $city;
        $this->resetPage(); 
    }

    public function selectCategory($category)
    {
        $this->selectedCategory = $category === $this->selectedCategory ? '' : $category;
        $this->selectedShop = ''; // ØªØµÙÙŠØ± Ø§Ù„Ù…Ø­Ù„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù…
        $this->resetPage(); 
    }

    public function mount()
    {
        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯ (shop_profile)
        if(request()->has('shop')) {
            $this->selectedShop = request('shop');
        }

        // Ø¬Ù„Ø¨ Ø§Ù„ÙØ¦Ø§Øª Ù…Ù† DB Ù…Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© - Ù…Ø¹ Caching
        // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ø¯Ù…Ø¬ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        $this->categoriesList = Cache::remember('categories_list_v2', 3600, function() {
            // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
            $customMap = [
                'Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© ÙˆØ·Ø§Ù‚Ø©' => ['icon' => 'ðŸ”Œâ˜€ï¸', 'subs' => []],
                'Ø£Ø«Ø§Ø« ÙˆÙ…ÙØ±ÙˆØ´Ø§Øª ÙˆØ®ÙŠØ§Ù…' => ['icon' => 'ðŸ›‹ï¸â›º', 'subs' => []],
                'Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ¯Ø±Ø§Ø¬Ø§Øª' => ['icon' => 'ðŸš—ðŸš²', 'subs' => []],
                'Ø¬ÙˆØ§Ù„Ø§Øª ÙˆØ¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª' => ['icon' => 'ðŸ“±', 'subs' => []],
                'Ù…Ø·Ø§Ø¹Ù…' => ['icon' => 'ðŸ½ï¸', 'subs' => []],
                'Ø¹Ù‚Ø§Ø±Ø§Øª' => ['icon' => 'ðŸ ', 'subs' => []],
                'Ù…Ù„Ø§Ø¨Ø³' => ['icon' => 'ðŸ‘•', 'subs' => ['Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ©', 'Ù…Ù„Ø§Ø¨Ø³ Ù†Ø³Ø§Ø¦ÙŠØ©', 'Ù…Ù„Ø§Ø¨Ø³ Ø£Ø·ÙØ§Ù„', 'Ø£Ø­Ø°ÙŠØ© ÙˆØ¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª']],
                'Ø®Ø¯Ù…Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©' => ['icon' => 'ðŸ§¾ðŸ’»', 'subs' => ['Ø§Ø³ØªØ¶Ø§ÙØ© ÙˆÙ…ÙˆØ§Ù‚Ø¹', 'ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©', 'ØªØ³ÙˆÙŠÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø®Ø¯Ù…Ø§Øª Ø¯ÙØ¹', 'ØµÙŠØ§Ù†Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©']],
                'Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ© ÙˆØ³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª' => ['icon' => 'ðŸ›’', 'subs' => ['Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡', 'Ø£Ù„Ø¨Ø§Ù†', 'Ù„Ø­ÙˆÙ… ÙˆØ¯ÙˆØ§Ø¬Ù†', 'Ù…ÙˆØ§Ø¯ Ù…Ø¹Ù„Ø¨Ø©', 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª ÙˆØ­Ù„ÙˆÙŠØ§Øª']],
                'Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆÙ„ÙˆØ§Ø²Ù… Ù…Ù†Ø²Ù„ÙŠØ©' => ['icon' => 'ðŸ§°', 'subs' => ['Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ Ø£Ø³Ø§Ø³ÙŠØ©', 'Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© ÙˆØ³Ø¨Ø§ÙƒØ©', 'Ø¯Ù‡Ø§Ù†Ø§Øª', 'Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„ÙŠ', 'Ø£Ø¯ÙˆØ§Øª ÙŠØ¯ÙˆÙŠØ©']],
                'ØµÙŠØ¯Ù„ÙŠØ§Øª ÙˆÙ…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©' => ['icon' => 'ðŸ©º', 'subs' => ['Ø£Ø¯ÙˆÙŠØ©', 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©', 'Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©', 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø·ÙØ§Ù„']],
                'Ø®Ø¯Ù…Ø§Øª Ø¹Ø§Ù…Ø©' => ['icon' => 'ðŸ› ï¸', 'subs' => ['ØµÙŠØ§Ù†Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©', 'ØªÙˆØµÙŠÙ„ ÙˆÙ†Ù‚Ù„', 'ØªÙ†Ø¸ÙŠÙ', 'ØªØµÙ„ÙŠØ­ Ø£Ø¬Ù‡Ø²Ø©']],
                'ØªØ±ÙÙŠÙ‡ ÙˆØ£Ù„Ø¹Ø§Ø¨ ÙˆØ±ÙŠØ§Ø¶Ø©' => ['icon' => 'ðŸŽ®âš½ï¸', 'subs' => ['Ø£Ù„Ø¹Ø§Ø¨ ÙÙŠØ¯ÙŠÙˆ', 'Ø£Ù„Ø¹Ø§Ø¨ Ø£Ø·ÙØ§Ù„', 'Ù…Ø¹Ø¯Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ©', 'Ø£Ù†Ø´Ø·Ø© ØªØ±ÙÙŠÙ‡ÙŠØ©']],
                'Ø²Ø±Ø§Ø¹Ø© ÙˆØ­ÙŠÙˆØ§Ù†Ø§Øª' => ['icon' => 'ðŸ”ðŸ„', 'subs' => ['Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£Ù„ÙŠÙØ©', 'Ø£Ø¹Ù„Ø§Ù', 'Ø£Ø¯ÙˆØ§Øª Ø²Ø±Ø§Ø¹Ø©', 'Ù…Ø¹Ø¯Ø§Øª Ø±ÙŠ']],
                'Ø£Ø®Ø±Ù‰' => ['icon' => 'ðŸ“¦', 'subs' => []],
            ];

            return Category::orderBy('id')->get()->map(function($c) use ($customMap) {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù…
                $custom = $customMap[$c->name] ?? null;
                
                return [
                    'name' => $c->name,
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
                    'icon' => $custom['icon'] ?? ($c->icon ?? 'ðŸ“¦'),
                    'slug' => $c->slug,
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ØµØµØ©
                    'subs' => array_unique(array_merge($c->subs ?? [], $custom['subs'] ?? [])),
                ];
            })->toArray();
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ù‘Ø© - Ù…Ø¹ Caching
        $this->ads = Cache::remember('active_ads', 300, function() {
            return Ad::where('is_active', true)->orderBy('order')->get()->groupBy('order')->toArray();
        });

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØ­Ø±Ùƒ (Ø§Ù„Ø¢Ù† ÙƒÙ€ array)
        $this->tickerText = [
            'ðŸ“¢ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ù…Ù†ØµØ© "Ø£Ø­Ø³Ù† Ø³Ø¹Ø±" - Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ ØºØ²Ø©',
            'ðŸ”¥ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ø±Ø®Øµ ØªØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹!',
            'âœ… ÙŠÙ…ÙƒÙ† Ù„Ø£ØµØ­Ø§Ø¨ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø¥Ø¶Ø§ÙØ© Ø¨Ø¶Ø§Ø¦Ø¹Ù‡Ù… ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø± Ø®Ø§Øµ Ù…Ø¬Ø§Ù†Ø§Ù‹',
            'âš ï¸ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ¯Ø§Ù‚ÙŠØ©',
            'ðŸ“ž Ù„Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…: @shady2013',
            'âœ¨ Ø§ÙƒØªØ´Ù Ù…ÙˆÙ‚Ø¹ Ø£Ø­Ø³Ù† Ø³Ø¹Ø± - Ù‚Ø§Ø±Ù†ØŒ Ø´Ø§Ø±ÙƒØŒ ÙˆÙˆÙÙ‘Ø±!',
        ];
    }

    public function render()
    {
        $query = Product::with('user')->where('is_approved', true);
        // ØªØ­Ø³ÙŠÙ†: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        $query = Product::select('id', 'name', 'price', 'image_path', 'city', 'shop_name', 'created_at', 'category', 'reference_code', 'condition')
            ->where('is_approved', true);
        // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© with('user') Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
        if ($this->selectedCategory) {
            $query->where('category', $this->selectedCategory);
        }

        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
        if ($this->selectedCity) {
            $query->where('city', $this->selectedCity);
        }

        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„
        if ($this->selectedShop) {
            $query->where('shop_name', $this->selectedShop);
        }

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
        if ($this->search) {
            $query->where('name', 'like', '%' . $this->search . '%');
        }

        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ø¬Ø¯ÙŠØ¯ / Ù…Ø³ØªØ¹Ù…Ù„)
        if ($this->condition) {
            $query->where('condition', $this->condition);
        }

        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹) Ø«Ù… Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        $products = $query->orderBy('price', 'asc')->orderBy('created_at', 'desc')->paginate(12);

        return view('livewire.home-page', [
            'products' => $products,
            'categoriesList' => $this->categoriesList,
            'ads' => $this->ads,
            'tickerText' => $this->tickerText,
        ]);
    }
}
